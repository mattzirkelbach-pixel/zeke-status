<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeke Ops Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=DM+Sans:wght@400;500;700&display=swap');
  :root {
    --bg: #0a0a0f; --surface: #12121a; --border: #1e1e2e;
    --text: #e0e0e8; --text-dim: #8888a0; --text-faint: #555568;
    --green: #22c55e; --amber: #f59e0b; --red: #ef4444;
    --blue: #3b82f6; --purple: #a855f7; --cyan: #06b6d4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); padding: 16px; min-height: 100vh; }
  .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .header h1 { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; color: var(--text); }
  .header h1 span { color: var(--text-faint); font-weight: 300; }
  .badge { padding: 4px 12px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-ok { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-warn { background: rgba(245,158,11,0.15); color: var(--amber); }
  .badge-crit { background: rgba(239,68,68,0.15); color: var(--red); }
  .meta { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-faint); text-align: right; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px; }
  .grid-full { grid-column: 1 / -1; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .card-title { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 12px; }
  .card-title .icon { margin-right: 6px; }
  .metric-row { display: flex; gap: 16px; flex-wrap: wrap; }
  .metric-item { flex: 1; min-width: 60px; }
  .metric-lg { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 600; }
  .metric-sm { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; }
  .metric-label { font-size: 11px; color: var(--text-faint); margin-top: 2px; }
  .log-box { font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.6; color: var(--text-dim); max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
  .log-box .fail { color: var(--red); }
  .log-box .pass { color: var(--green); }
  .domain-bar { display: flex; align-items: center; margin: 4px 0; }
  .domain-name { font-family: 'JetBrains Mono', monospace; font-size: 11px; width: 120px; color: var(--text-dim); }
  .domain-fill { height: 14px; border-radius: 2px; min-width: 4px; }
  .domain-count { font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-left: 8px; color: var(--text-faint); }
  .loop-viz { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center; padding: 12px 0; }
  .loop-node { padding: 8px 16px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; border: 2px solid; }
  .loop-arrow { color: var(--text-faint); font-size: 18px; }
  .loop-ok { border-color: var(--green); color: var(--green); background: rgba(34,197,94,0.08); }
  .loop-warn { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.08); }
  .loop-fail { border-color: var(--red); color: var(--red); background: rgba(239,68,68,0.08); }
  canvas { width: 100%; height: 120px; }
  .chart-container { position: relative; height: 140px; margin-top: 8px; }
</style>
</head>
<body>
<div class="header">
  <h1>ZEKE <span>ops</span></h1>
  <div>
    <span id="health-badge" class="badge">...</span>
    <div class="meta" id="meta-time">loading...</div>
  </div>
</div>
<div class="grid" id="dashboard"></div>

<script>
const STATUS_URL = 'https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/status.json';
const HISTORY_URL = 'https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/history.jsonl';

let state = {};
let history = [];

async function fetchData() {
  try {
    const [statusRes, historyRes] = await Promise.all([
      fetch(STATUS_URL + '?t=' + Date.now()),
      fetch(HISTORY_URL + '?t=' + Date.now())
    ]);
    state = await statusRes.json();
    const histText = await historyRes.text();
    history = histText.trim().split('\n').filter(Boolean).map(l => {
      try { return JSON.parse(l); } catch { return null; }
    }).filter(Boolean);
  } catch (e) {
    console.error('Fetch error:', e);
  }
  render();
}

function ago(ts) {
  if (!ts) return '?';
  const d = (Date.now() - new Date(ts).getTime()) / 1000;
  if (d < 60) return Math.round(d) + 's ago';
  if (d < 3600) return Math.round(d/60) + 'm ago';
  if (d < 86400) return Math.round(d/3600) + 'h ago';
  return Math.round(d/86400) + 'd ago';
}

function sparkline(canvas, data, color) {
  if (!data.length) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2, 2);
  const rw = canvas.offsetWidth;
  const rh = canvas.offsetHeight;
  const max = Math.max(...data) || 1;
  const min = Math.min(...data);
  const range = max - min || 1;
  const step = rw / Math.max(data.length - 1, 1);

  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  data.forEach((v, i) => {
    const x = i * step;
    const y = rh - 8 - ((v - min) / range) * (rh - 16);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill under
  ctx.lineTo((data.length - 1) * step, rh);
  ctx.lineTo(0, rh);
  ctx.closePath();
  ctx.fillStyle = color.replace(')', ',0.08)').replace('rgb', 'rgba');
  ctx.fill();
}

function parseKG(kgStr) {
  const r = {};
  if (!kgStr) return r;
  const m = kgStr.match(/Entities: (\d+)/); if (m) r.entities = +m[1];
  const m2 = kgStr.match(/Relationships: (\d+)/); if (m2) r.relationships = +m2[1];
  const m3 = kgStr.match(/Associations: (\d+)/); if (m3) r.associations = +m3[1];
  const m4 = kgStr.match(/Insights: (\d+)/); if (m4) r.insights = +m4[1];
  const dm = kgStr.match(/Domains: ({[\s\S]*})/);
  if (dm) try { r.domains = JSON.parse(dm[1]); } catch {}
  return r;
}

function getHealth() {
  const gw = state.gateway_process || {};
  const sp = state.spark_status || {};
  const fq = state.feed_quality || {};
  if (gw.status !== 'RUNNING' || sp.status !== 'ONLINE') return 'CRITICAL';
  if ((fq.error_rate || 0) > 15) return 'DEGRADED';
  const jobs = state.last_jobs || [];
  const fails = jobs.filter(j => j.result === 'FAILED').length;
  if (fails > jobs.length / 2) return 'DEGRADED';
  return 'HEALTHY';
}

function render() {
  const kg = parseKG(state.kg_stats);
  const gpu = state.gpu_stats || {};
  const gw = state.gateway_process || {};
  const sp = state.spark_status || {};
  const fq = state.feed_quality || {};
  const cs = state.crontab_status || {};
  const gc = state.gateway_config || {};
  const jobs = state.last_jobs || [];
  const health = getHealth();

  // Health badge
  const hb = document.getElementById('health-badge');
  hb.textContent = health;
  hb.className = 'badge ' + (health === 'HEALTHY' ? 'badge-ok' : health === 'DEGRADED' ? 'badge-warn' : 'badge-crit');
  document.getElementById('meta-time').textContent = ago(state.timestamp) + ' | auto-refresh 60s';

  const feedHistory = history.map(h => h.feed_lines).filter(v => v != null);
  const entityHistory = history.map(h => h.kg_entities).filter(v => v != null);
  const gpuHistory = history.map(h => h.gpu_util_pct).filter(v => v != null);
  const tempHistory = history.map(h => h.gpu_temp_c).filter(v => v != null);
  const errorHistory = history.map(h => h.feed_error_rate).filter(v => v != null);

  const passedJobs = jobs.filter(j => j.result === 'SUCCESS').length;
  const failedJobs = jobs.filter(j => j.result === 'FAILED').length;
  const totalJobs = jobs.length;

  const domains = kg.domains || {};
  const domainColors = ['#3b82f6','#22c55e','#f59e0b','#a855f7','#ef4444','#06b6d4','#f97316','#ec4899'];
  const maxDomain = Math.max(...Object.values(domains), 1);

  const domainBars = Object.entries(domains).map(([name, count], i) =>
    '<div class="domain-bar">' +
      '<span class="domain-name">' + name + '</span>' +
      '<div class="domain-fill" style="width:' + Math.round(count/maxDomain*200) + 'px;background:' + domainColors[i % domainColors.length] + '"></div>' +
      '<span class="domain-count">' + count + '</span>' +
    '</div>'
  ).join('');

  // Queue log
  const queueLog = (state['zeke-queue_tail'] || []).map(l => {
    if (l.includes('FAILED')) return '<span class="fail">' + escHtml(l) + '</span>';
    if (l.includes('SUCCESS') || l.includes('DONE') || l.includes('feed=')) return '<span class="pass">' + escHtml(l) + '</span>';
    return escHtml(l);
  }).join('\n');

  // Self-heal
  const healLog = escHtml((state.self_heal_log || '').slice(0, 1500)) || 'No issues logged';

  // Evals
  const evals = (state.recent_evaluations || []).slice(-5).map(e => {
    try {
      const ev = JSON.parse(e);
      const score = ev.novelty_score || ev.score || '?';
      const color = score >= 4 ? 'var(--green)' : score >= 3 ? 'var(--amber)' : 'var(--text-faint)';
      return '<span style="color:' + color + '">[' + score + '/5]</span> ' + escHtml(ev.topic || '?');
    } catch { return escHtml(e); }
  }).join('\n');

  // Closed loop assessment
  const gatherOk = gw.status === 'RUNNING' && sp.status === 'ONLINE';
  const extractOk = (kg.entities || 0) > 50;
  const assocRate = (kg.entities||1) > 0 ? (kg.associations||0)/(kg.entities||1) : 0;
  const assocOk = assocRate > 0.3;
  const reasonOk = cs.has_reason === true;

  const dash = document.getElementById('dashboard');
  dash.innerHTML = `
    <!-- Row 1: Infrastructure -->
    <div class="card">
      <div class="card-title"><span class="icon">ðŸ–¥</span> Gateway</div>
      <div class="metric-row">
        <div class="metric-item">
          <div class="metric-sm" style="color:${gw.status==='RUNNING' ? 'var(--green)' : 'var(--red)'}">${gw.status || '?'}</div>
          <div class="metric-label">PID ${gw.pid || '?'}</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${gw.memory_pct || '?'}%</div>
          <div class="metric-label">memory</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${gw.uptime || '?'}</div>
          <div class="metric-label">uptime</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ðŸ”¥</span> Spark GPU</div>
      ${gpu.status === 'OK' ? `
        <div class="metric-row">
          <div class="metric-item">
            <div class="metric-sm" style="color:${(gpu.gpu_util_pct||0) > 80 ? 'var(--green)' : (gpu.gpu_util_pct||0) > 10 ? 'var(--amber)' : 'var(--text-faint)'}">${gpu.gpu_util_pct != null ? gpu.gpu_util_pct + '%' : 'N/A'}</div>
            <div class="metric-label">GPU util</div>
          </div>
          <div class="metric-item">
            <div class="metric-sm">${gpu.temp_c != null ? gpu.temp_c + '\u00b0C' : 'N/A'}</div>
            <div class="metric-label">temp</div>
          </div>
          <div class="metric-item">
            <div class="metric-sm">${gpu.power_w != null ? Math.round(gpu.power_w) + 'W' : 'N/A'}</div>
            <div class="metric-label">power</div>
          </div>
        </div>
        <div class="metric-label" style="margin-top:6px">${gpu.gpu_name || ''} &bull; ${(sp.loaded_models||[]).map(m=>m.name).join(', ')}</div>
      ` : `<div class="metric-label">GPU: ${gpu.status || 'NO DATA'}</div>`}
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ðŸ“Š</span> Knowledge Graph</div>
      <div class="metric-row">
        <div class="metric-item">
          <div class="metric-lg" style="color:var(--blue)">${kg.entities || 0}</div>
          <div class="metric-label">entities</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${kg.relationships || 0}</div>
          <div class="metric-label">relationships</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${kg.associations || 0}</div>
          <div class="metric-label">associations</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${kg.insights || 0}</div>
          <div class="metric-label">insights</div>
        </div>
      </div>
    </div>

    <!-- Row 2: Feed + Queue -->
    <div class="card">
      <div class="card-title"><span class="icon">ðŸ“¡</span> Research Feed</div>
      <div class="metric-row">
        <div class="metric-item">
          <div class="metric-lg" style="color:var(--cyan)">${state.feed_lines || 0}</div>
          <div class="metric-label">entries</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm" style="color:${(fq.error_rate||0) > 10 ? 'var(--red)' : 'var(--green)'}">${fq.error_rate || 0}%</div>
          <div class="metric-label">error rate</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm">${state.evaluation_count || 0}</div>
          <div class="metric-label">evaluated</div>
        </div>
      </div>
      <div class="metric-label" style="margin-top:8px">bad JSON: ${fq.malformed_json||0} | bad timestamps: ${fq.literal_timestamps||0} | dupes: ${fq.duplicates||0} | empty: ${fq.no_new_dev||0}</div>
      <div class="chart-container"><canvas id="chart-feed"></canvas></div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">âš¡</span> Queue Health</div>
      <div class="metric-row">
        <div class="metric-item">
          <div class="metric-sm" style="color:${passedJobs > 0 ? 'var(--green)' : 'var(--red)'}">${passedJobs}/${totalJobs}</div>
          <div class="metric-label">passed / total</div>
        </div>
        <div class="metric-item">
          <div class="metric-sm" style="color:var(--red)">${failedJobs}</div>
          <div class="metric-label">failed</div>
        </div>
      </div>
      <div class="log-box" style="margin-top:8px">${jobs.map(j => {
        const c = j.result === 'FAILED' ? 'fail' : j.result === 'SUCCESS' ? 'pass' : '';
        return '<span class="' + c + '">' + (j.topic||'?') + ' ' + (j.result||'?') + ' ' + (j.duration_s ? j.duration_s+'s' : '') + '</span>';
      }).join('\n')}</div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ðŸ—‚</span> Domains</div>
      ${domainBars || '<div class="metric-label">No domain data</div>'}
    </div>

    <!-- Row 3: Charts -->
    <div class="card grid-full">
      <div class="card-title"><span class="icon">ðŸ“ˆ</span> Trends (${history.length} data points)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <div>
          <div class="metric-label">Feed Growth</div>
          <div class="chart-container"><canvas id="chart-feed-trend"></canvas></div>
        </div>
        <div>
          <div class="metric-label">KG Entities</div>
          <div class="chart-container"><canvas id="chart-kg-trend"></canvas></div>
        </div>
        <div>
          <div class="metric-label">Feed Error Rate %</div>
          <div class="chart-container"><canvas id="chart-error-trend"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Row 4: Closed Loop -->
    <div class="card grid-full">
      <div class="card-title"><span class="icon">ðŸ”„</span> Closed Loop Status</div>
      <div class="loop-viz">
        <div class="loop-node ${gatherOk ? 'loop-ok' : 'loop-fail'}">GATHER</div>
        <div class="loop-arrow">â†’</div>
        <div class="loop-node ${extractOk ? 'loop-ok' : 'loop-warn'}">EXTRACT</div>
        <div class="loop-arrow">â†’</div>
        <div class="loop-node ${assocOk ? 'loop-ok' : 'loop-warn'}">ASSOCIATE</div>
        <div class="loop-arrow">â†’</div>
        <div class="loop-node ${reasonOk ? 'loop-ok' : 'loop-fail'}">REASON</div>
        <div class="loop-arrow">â†’</div>
        <div class="loop-node loop-fail">ACT</div>
        <div class="loop-arrow">â†’</div>
      </div>
      <div class="metric-label" style="text-align:center">
        GATHER: ${gatherOk ? 'infra online' : 'infra down'} |
        EXTRACT: ${(kg.entities||0)} entities |
        ASSOCIATE: ${Math.round(assocRate*100)}% rate |
        REASON: ${reasonOk ? '7am cron active' : 'not scheduled'} |
        ACT: requires human
      </div>
    </div>

    <!-- Row 5: Logs -->
    <div class="card">
      <div class="card-title"><span class="icon">ðŸ”§</span> Self-Heal Log</div>
      <div class="log-box">${healLog}</div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ðŸ“‹</span> Queue Log</div>
      <div class="log-box">${queueLog}</div>
    </div>

    <div class="card">
      <div class="card-title"><span class="icon">ðŸ’Ž</span> Recent Evaluations</div>
      <div class="log-box">${evals || 'None yet'}</div>
    </div>

    <!-- Row 6: System -->
    <div class="card grid-full">
      <div class="card-title"><span class="icon">âš™</span> System</div>
      <div class="metric-label">
        Cron: ${cs.active||0} active | Queue: ${cs.has_queue ? 'ON' : 'OFF'} | Reason: ${cs.has_reason ? 'ON' : 'OFF'} | Overnight: ${cs.has_overnight ? 'ON' : 'OFF'} |
        Models: ${Object.keys(gc.byProvider||{}).length} configured |
        Spark: ${sp.status || '?'} |
        Dashboard: auto-refresh 60s
      </div>
    </div>
  `;

  // Draw charts after DOM update
  setTimeout(() => {
    const cf = document.getElementById('chart-feed-trend');
    if (cf && feedHistory.length > 1) sparkline(cf, feedHistory, 'rgb(6,182,212)');
    const ck = document.getElementById('chart-kg-trend');
    if (ck && entityHistory.length > 1) sparkline(ck, entityHistory, 'rgb(59,130,246)');
    const ce = document.getElementById('chart-error-trend');
    if (ce && errorHistory.length > 1) sparkline(ce, errorHistory, 'rgb(239,68,68)');
  }, 50);
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

fetchData();
setInterval(fetchData, 60000);
</script>
</body>
</html>