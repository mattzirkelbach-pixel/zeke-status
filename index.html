<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeke Mission Control</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  :root {
    --bg:#08090a; --sf:#111214; --sf2:#161819; --bdr:#222426; --bdr2:#1a1b1d;
    --tx:#e4e5e7; --mut:#7a7d82; --dim:#454750;
    --grn:#2dd4a0; --grn2:#0d3d30; --amb:#f0b429; --amb2:#3d2e0a;
    --red:#e5484d; --red2:#3d1214; --blu:#4da3ff; --pur:#9d8cff; --cyn:#22d3ee;
    --mono:'JetBrains Mono','SF Mono','Menlo',monospace;
    --sans:-apple-system,BlinkMacSystemFont,sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--tx);font-family:var(--sans);padding:20px 24px;max-width:960px;margin:0 auto}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .hdr{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:20px;animation:fadeUp .5s ease}
  .hdr h1{font-size:20px;font-weight:700;letter-spacing:-.03em}
  .hdr-sub{font-size:10px;font-family:var(--mono);color:var(--dim);margin-top:2px}
  .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
  .dot-g{background:var(--grn);box-shadow:0 0 6px var(--grn)}
  .dot-a{background:var(--amb)}
  .dot-r{background:var(--red);box-shadow:0 0 6px var(--red)}
  .dot-d{background:var(--dim)}
  .ind{display:inline-flex;align-items:center;gap:6px;font:500 11px var(--mono);color:var(--mut)}
  .metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;animation:fadeUp .5s ease .05s both}
  .m{padding:12px 10px;background:var(--sf);border:1px solid var(--bdr);border-radius:10px;text-align:center}
  .mv{font:700 24px var(--mono);line-height:1}
  .ml{font:500 8px var(--mono);color:var(--dim);margin-top:5px;letter-spacing:.1em}
  .ms{font:400 9px var(--mono);color:var(--dim);margin-top:2px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;animation:fadeUp .5s ease .1s both}
  .card{padding:16px 18px;background:var(--sf);border:1px solid var(--bdr);border-radius:12px}
  .card-w{grid-column:1/-1}
  .ct{font:600 10px var(--mono);color:var(--dim);letter-spacing:.08em;text-transform:uppercase;margin-bottom:14px}
  .topo{display:grid;grid-template-columns:1fr 30px 1fr 30px 1fr;align-items:center;margin-bottom:14px}
  .tn{padding:12px;background:var(--sf2);border:1px solid var(--bdr);border-radius:10px;text-align:center;position:relative}
  .tn-l{font:600 11px var(--mono)}
  .tn-s{font:400 8px var(--mono);color:var(--dim);margin-top:2px}
  .tn .dot{position:absolute;top:6px;right:6px;width:6px;height:6px}
  .ta{text-align:center;color:var(--dim);font-size:16px}
  .ta.on{color:var(--grn)}
  .dets{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .det{padding:8px 10px;background:var(--sf2);border-radius:8px}
  .det-l{font:500 9px var(--mono);color:var(--dim);margin-bottom:3px}
  .det-v{font:600 11px var(--mono)}
  .det-s{font:400 9px var(--mono);color:var(--dim)}
  .act{padding:12px 14px;background:var(--sf2);border-radius:8px;margin-top:10px;border-left:3px solid var(--grn)}
  .act-dim{border-left-color:var(--dim)}
  .hw{padding:10px 12px;background:var(--sf2);border-radius:8px;border:1px solid var(--bdr2);margin-bottom:8px}
  .hw:last-child{margin-bottom:0}
  .hw-h{display:flex;justify-content:space-between;align-items:center}
  .hw-n{font:600 11px var(--mono)}
  .hw-d{font:400 9px var(--mono);color:var(--dim);margin-top:4px}
  .fe{font:400 10px var(--mono);padding:3px 0 3px 10px;border-left:2px solid var(--bdr2);color:var(--dim)}
  .fe:first-child{border-left-color:var(--grn);color:var(--mut)}
  .iss{font:400 10px var(--mono);color:var(--mut);padding:4px 0;border-bottom:1px solid var(--bdr2)}
  .iss:last-child{border-bottom:none}
  .jr{display:grid;grid-template-columns:95px 1fr 55px 20px;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--bdr2)}
  .jn{font:400 10px var(--mono);color:var(--mut)}
  .jb{height:14px;background:var(--sf2);border-radius:3px;overflow:hidden}
  .jf{height:100%;border-radius:3px;transition:width .5s ease}
  .jm{font:400 9px var(--mono);color:var(--dim);text-align:right}
  .ft{margin-top:20px;padding-top:12px;border-top:1px solid var(--bdr);display:flex;justify-content:space-between;font:400 9px var(--mono);color:var(--dim)}
  .ft a{color:var(--mut);text-decoration:none}
  @media(max-width:700px){.metrics{grid-template-columns:repeat(3,1fr)}.grid{grid-template-columns:1fr}.card-w{grid-column:auto}.dets{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="hdr">
  <div>
    <h1>Mission Control</h1>
    <div class="hdr-sub" id="sub">loading...</div>
  </div>
  <div id="health" class="ind"><span class="dot dot-d"></span> LOADING</div>
</div>
<div class="metrics" id="met"></div>
<div class="grid" id="grid"></div>
<div class="ft">
  <span>Zeke v2 â€¢ <span id="ft-f">â€”</span> entries</span>
  <a href="https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/diagnostic.json" target="_blank">raw â†—</a>
</div>
<script>
const RAW="https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main";
let rc=0, fh=[];

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function chart(pts,opts={}){
  const{w=400,h=110,color='#2dd4a0'}=opts;
  if(!pts||pts.length<2)return`<div style="height:${h}px;display:flex;align-items:center;justify-content:center"><span style="font:11px var(--mono);color:var(--dim)">Collecting data points...</span></div>`;
  const p={t:8,r:10,b:22,l:36},cw=w-p.l-p.r,ch=h-p.t-p.b;
  const vs=pts.map(p=>p.v),yMn=Math.min(...vs),yMx=Math.max(...vs),yr=yMx-yMn||1;
  const tMn=pts[0].t,tMx=pts[pts.length-1].t,tr=tMx-tMn||1;
  const X=t=>p.l+((t-tMn)/tr)*cw, Y=v=>p.t+ch-((v-yMn)/yr)*ch;
  const pp=pts.map(pt=>`${X(pt.t).toFixed(1)},${Y(pt.v).toFixed(1)}`);
  const ld=pp.map((pt,i)=>`${i?'L':'M'} ${pt}`).join(' ');
  const ad=ld+` L ${X(tMx).toFixed(1)} ${(p.t+ch)} L ${X(tMn).toFixed(1)} ${(p.t+ch)} Z`;
  const gid='g'+Math.random().toString(36).slice(2,8);
  const yt=[yMn,yMn+yr*.5,yMx].map(v=>Math.round(v));
  let svg=`<svg width="100%" viewBox="0 0 ${w} ${h}" style="display:block;overflow:visible">`;
  svg+=`<defs><linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${color}" stop-opacity=".2"/><stop offset="100%" stop-color="${color}" stop-opacity="0"/></linearGradient></defs>`;
  yt.forEach(v=>{svg+=`<line x1="${p.l}" y1="${Y(v)}" x2="${w-p.r}" y2="${Y(v)}" stroke="var(--bdr2)" stroke-width=".5" stroke-dasharray="3,3"/><text x="${p.l-4}" y="${Y(v)+3}" text-anchor="end" fill="var(--dim)" font-size="9" font-family="var(--mono)">${v}</text>`});
  svg+=`<path d="${ad}" fill="url(#${gid})"/>`;
  svg+=`<path d="${ld}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>`;
  pts.forEach((pt,i)=>{const last=i===pts.length-1;svg+=`<circle cx="${X(pt.t)}" cy="${Y(pt.v)}" r="${last?3.5:2}" fill="${last?color:color+'88'}" ${last?`stroke="var(--bg)" stroke-width="1.5"`:''}/>`});
  const step=Math.max(1,Math.floor(pts.length/6));
  for(let i=0;i<pts.length;i+=step)svg+=`<text x="${X(pts[i].t)}" y="${h-4}" text-anchor="middle" fill="var(--dim)" font-size="8" font-family="var(--mono)">${pts[i].l}</text>`;
  if(pts.length%step!==0)svg+=`<text x="${X(tMx)}" y="${h-4}" text-anchor="middle" fill="var(--dim)" font-size="8" font-family="var(--mono)">${pts[pts.length-1].l}</text>`;
  return svg+'</svg>';
}

function render(d){
  if(!d)return;
  const fc=d.feed?.total_lines||0;
  const sp=d.spark||{};
  const gw=d.gateway?.running||false;
  const sc=d.scheduler||{};
  const act=d.activity||{};
  const hp=d.health||{};
  const iss=hp.issues||[];
  const entries=d.feed?.last_entries||[];
  const hr=new Date().getHours();
  const win=hr>=21||hr<5?'overnight':hr<6?'maintenance':'daytime';

  // Header
  const age=d.feed?.last_modified_minutes_ago;
  const ageStr=age!=null?Math.round(age)+'m ago':'?';
  document.getElementById('sub').textContent=`${win} â€¢ diag ${d.timestamp_local?.slice(11)||'?'} â€¢ feed ${ageStr} â€¢ refresh #${rc}`;
  const hcls=hp.status==='HEALTHY'?'dot-g':iss.some(i=>i.includes('CRITICAL'))?'dot-r':'dot-a';
  document.getElementById('health').innerHTML=`<span class="dot ${hcls}"></span> ${hp.status||'?'}`;

  // Metrics
  const sr=act.jobs_today>0?Math.round(act.success_today/act.jobs_today*100):0;
  document.getElementById('met').innerHTML=[
    {l:'FEED',v:fc,c:'var(--grn)',s:'+'+String(act.feed_growth_today||0)+' today'},
    {l:'JOBS TODAY',v:act.jobs_today||0,c:'var(--blu)',s:sr+'% success'},
    {l:'OK/TMO/FAIL',v:`${act.success_today||0}/${act.timeout_today||0}/${act.fail_today||0}`,c:'var(--cyn)',s:'today'},
    {l:'STATE',v:act.state==='sleeping between cycles'?'SLEEP':act.state==='running cycle'?'ACTIVE':String(act.state||'?').slice(0,8).toUpperCase(),c:act.state?.includes('running')?'var(--grn)':act.state?.includes('sleep')?'var(--blu)':'var(--amb)',s:act.next_cycle_est?'next ~'+act.next_cycle_est:''},
    {l:'COST',v:'$0',c:'var(--grn)',s:'local models'},
  ].map(m=>`<div class="m"><div class="mv" style="color:${m.c}">${m.v}</div><div class="ml">${m.l}</div>${m.s?`<div class="ms">${m.s}</div>`:''}</div>`).join('');

  let g='';

  // Topology
  const allUp=sc.running&&gw&&sp.online;
  const acls=allUp?'ta on':'ta';
  g+=`<div class="card card-w"><div class="ct">System Topology</div>
    <div class="topo">
      <div class="tn"><span class="dot ${sc.running?'dot-g':'dot-r'}" style="width:6px;height:6px"></span><div class="tn-l">Scheduler</div><div class="tn-s">Python</div></div>
      <div class="${acls}">â†’</div>
      <div class="tn"><span class="dot ${gw?'dot-g':'dot-r'}" style="width:6px;height:6px"></span><div class="tn-l">Gateway</div><div class="tn-s">OpenClaw</div></div>
      <div class="${acls}">â†’</div>
      <div class="tn"><span class="dot ${sp.online?(sp.model_stuck?'dot-a':'dot-g'):'dot-r'}" style="width:6px;height:6px"></span><div class="tn-l">DGX Spark</div><div class="tn-s">${(sp.models_loaded||[])[0]||'idle'}</div></div>
    </div>
    <div class="dets">
      <div class="det"><div class="det-l">SCHEDULER</div><div class="det-v" style="color:${sc.running?'var(--tx)':'var(--red)'}">${sc.running?'PID '+(sc.pids||[])[0]:'DOWN'}</div><div class="det-s">${act.state||'unknown'}</div></div>
      <div class="det"><div class="det-l">SPARK</div><div class="det-v" style="color:${sp.online?'var(--tx)':'var(--red)'}">${sp.online?(sp.model_stuck?'STUCK':'HEALTHY'):'OFFLINE'}</div><div class="det-s">${sp.detail||''}</div></div>
      <div class="det"><div class="det-l">FEED QUALITY</div><div class="det-v">${d.feed?.recent_50_clean||'?'}<span style="color:var(--dim);font-size:9px">/${(d.feed?.recent_50_clean||0)+(d.feed?.recent_50_broken||0)}</span></div><div class="det-s">${ageStr} since last write</div></div>
    </div>`;

  // Activity bar - the feedback mechanism
  const lastJob=act.last_job_time||'â€”';
  const nextCycle=act.next_cycle_est||'â€”';
  const actBorder=act.state?.includes('running')?'':'act-dim';
  g+=`<div class="act ${actBorder}">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <span style="font:600 10px var(--mono);color:${act.state?.includes('running')?'var(--grn)':'var(--blu)'}">${act.state?.includes('running')?'âš¡ PROCESSING':'ðŸ’¤ SLEEPING'}</span>
      <span style="font:400 9px var(--mono);color:var(--dim)">last job: ${lastJob} â†’ next: ~${nextCycle}</span>
    </div>
  </div></div>`;

  // Feed chart
  g+=`<div class="card"><div class="ct">Feed Growth</div>${chart(fh,{color:'#2dd4a0'})}<div style="display:flex;justify-content:space-between;margin-top:6px;font:9px var(--mono);color:var(--dim)"><span>${fh.length} points</span><span>every 60s</span></div></div>`;

  // Hardware
  g+=`<div class="card"><div class="ct">Hardware</div>
    <div class="hw"><div class="hw-h"><span class="hw-n">Mac Mini</span><span class="ind"><span class="dot dot-g" style="width:6px;height:6px"></span>HOST</span></div><div class="hw-d">Gateway + Scheduler + Guardian</div></div>
    <div class="hw" ${sp.model_stuck?'style="border-color:var(--amb2)"':''}><div class="hw-h"><span class="hw-n">DGX Spark</span><span class="ind"><span class="dot ${sp.online?'dot-g':'dot-r'}" style="width:6px;height:6px"></span>${sp.online?'10.0.0.143':'OFFLINE'}</span></div><div class="hw-d">128GB VRAM â€¢ ${(sp.models_loaded||[]).join(', ')||'idle'}</div>${sp.model_stuck?'<div class="hw-d" style="color:var(--amb)">âš  Model stuck</div>':''}</div>
    <div class="hw"><div class="hw-h"><span class="hw-n">Network</span><span class="ind"><span class="dot ${allUp?'dot-g':'dot-a'}" style="width:6px;height:6px"></span>LAN</span></div><div class="hw-d">Mini â†’ Gateway :18789 â†’ Spark :11434</div></div>
    <div class="hw"><div class="hw-h"><span class="hw-n">Telegram</span><span class="ind"><span class="dot dot-g" style="width:6px;height:6px"></span>@Zekevonz_bot</span></div><div class="hw-d">Action-required insights only</div></div>
  </div>`;

  // Issues
  if(iss.length>0){
    g+=`<div class="card card-w" style="background:rgba(240,180,41,.04);border-color:var(--amb2)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span class="dot ${iss.some(i=>i.includes('CRITICAL'))?'dot-r':'dot-a'}"></span><span style="font:600 12px var(--mono);color:var(--amb)">${iss.length} Issue${iss.length>1?'s':''}</span></div>
      ${iss.map(i=>`<div class="iss">${esc(i)}</div>`).join('')}
    </div>`;
  }

  // Feed entries
  g+=`<div class="card card-w"><div class="ct">Latest Entries</div>${
    entries.length>0?entries.map((e,i)=>`<div class="fe" ${i===0?'style="border-left-color:var(--grn);color:var(--mut)"':''}>${esc(typeof e==='string'?e.slice(0,100):JSON.stringify(e).slice(0,100))}</div>`).join('')
    :'<div style="font:10px var(--mono);color:var(--dim)">Waiting...</div>'
  }</div>`;

  document.getElementById('grid').innerHTML=g;
  document.getElementById('ft-f').textContent=fc;
}

async function tick(){
  rc++;
  try{
    const d=await fetch(RAW+'/diagnostic.json?t='+Date.now()).then(r=>r.ok?r.json():null).catch(()=>null);
    const now=new Date();
    const lbl=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    const fc=d?.feed?.total_lines;
    if(fc){fh.push({t:now.getTime(),v:fc,l:lbl});if(fh.length>48)fh=fh.slice(-48)}
    render(d);
  }catch(e){console.error(e)}
}
tick();
setInterval(tick,60000);
</script>
</body>
</html>
