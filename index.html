<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeke</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000000;
    --surface: rgba(255,255,255,0.03);
    --border: rgba(255,255,255,0.06);
    --border-s: rgba(255,255,255,0.1);
    --text: rgba(255,255,255,0.92);
    --t2: rgba(255,255,255,0.55);
    --t3: rgba(255,255,255,0.3);
    --green: #30d158;
    --amber: #ffd60a;
    --red: #ff453a;
    --blue: #0a84ff;
    --cyan: #64d2ff;
    --purple: #bf5af2;
    --r: 14px;
    --font: "Geist", -apple-system, sans-serif;
    --mono: "Geist Mono", ui-monospace, monospace;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh; -webkit-font-smoothing: antialiased; }
  .hdr { display: flex; justify-content: space-between; align-items: baseline; padding: 8px 0 28px; }
  .wm { font-family: var(--mono); font-size: 13px; font-weight: 500; letter-spacing: 0.12em; text-transform: uppercase; color: var(--t2); }
  .hp { display: flex; align-items: center; gap: 8px; }
  .hd { width: 7px; height: 7px; border-radius: 50%; animation: p 2s ease-in-out infinite; }
  @keyframes p { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .hl { font-family: var(--mono); font-size: 11px; color: var(--t3); }
  .g { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; }
  @media(max-width:900px){.g{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:600px){.g{grid-template-columns:1fr}}
  .s2 { grid-column: span 2; }
  .s3 { grid-column: span 3; }
  @media(max-width:900px){.s2,.s3{grid-column:span 2}}
  @media(max-width:600px){.s2,.s3{grid-column:span 1}}
  .c { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 18px 20px; transition: border-color .2s; }
  .c:hover { border-color: var(--border-s); }
  .cl { font-family: var(--mono); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .08em; color: var(--t3); margin-bottom: 14px; }
  .v { font-family: var(--mono); font-weight: 500; font-size: 32px; letter-spacing: -.02em; line-height: 1; }
  .vs { font-family: var(--mono); font-weight: 500; font-size: 20px; line-height: 1; }
  .lb { font-size: 11px; color: var(--t3); margin-top: 4px; }
  .mr { display: flex; gap: 24px; flex-wrap: wrap; }
  .mi { min-width: 60px; }
  .st { font-family: var(--mono); font-size: 10px; color: var(--t3); margin-top: 10px; line-height: 1.5; }
  .ca { height: 60px; margin-top: 12px; }
  canvas { width: 100%; height: 100%; }
  .lc { display: flex; align-items: center; gap: 4px; justify-content: center; padding: 8px 0; flex-wrap: wrap; }
  .ls { font-family: var(--mono); font-size: 11px; font-weight: 500; padding: 6px 14px; border-radius: 8px; border: 1px solid; }
  .lok { border-color: rgba(48,209,88,.3); color: var(--green); background: rgba(48,209,88,.06); }
  .lw { border-color: rgba(255,214,10,.3); color: var(--amber); background: rgba(255,214,10,.06); }
  .lo { border-color: var(--border); color: var(--t3); }
  .la { color: var(--t3); font-size: 12px; padding: 0 2px; }
  .dr { display: flex; align-items: center; margin: 3px 0; gap: 8px; }
  .dn { font-family: var(--mono); font-size: 10px; color: var(--t3); width: 100px; text-align: right; flex-shrink: 0; }
  .db { flex: 1; height: 6px; background: rgba(255,255,255,.03); border-radius: 3px; overflow: hidden; }
  .df { height: 100%; border-radius: 3px; transition: width .6s ease; }
  .dv { font-family: var(--mono); font-size: 10px; color: var(--t3); width: 30px; }
  .la2 { font-family: var(--mono); font-size: 10px; line-height: 1.7; color: var(--t3); max-height: 160px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
  .la2 .f { color: var(--red); } .la2 .o { color: var(--green); }
  .jr { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-family: var(--mono); font-size: 10px; border-bottom: 1px solid var(--border); }
  .jr:last-child { border-bottom: none; }
  .jt { color: var(--t2); flex: 1; }
  .js { width: 50px; text-align: right; }
  .jd { color: var(--t3); width: 50px; text-align: right; }
</style>
</head>
<body>
<div class="hdr">
  <div class="wm">Zeke</div>
  <div class="hp"><div class="hd" id="hd"></div><div class="hl" id="hl">loading</div></div>
</div>
<div class="g" id="g"></div>
<script>
const SRC="https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/status.json";
const HST="https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/history.jsonl";
let S={},H=[];

async function ld(){
  try{
    const[a,b]=await Promise.all([fetch(SRC+"?_="+Date.now()),fetch(HST+"?_="+Date.now())]);
    S=await a.json();
    H=(await b.text()).trim().split("\n").filter(Boolean).map(l=>{try{return JSON.parse(l)}catch{return null}}).filter(Boolean);
  }catch(e){console.error(e)}
  rn();
}

function ago(ts){
  if(!ts)return"\u2014";
  const s=(Date.now()-new Date(ts).getTime())/1000;
  if(s<60)return Math.round(s)+"s";if(s<3600)return Math.round(s/60)+"m";
  if(s<86400)return Math.round(s/3600)+"h";return Math.round(s/86400)+"d";
}

function sp(cv,d,col){
  if(!d||d.length<2)return;
  const c=cv.getContext("2d"),dpr=devicePixelRatio||1,w=cv.offsetWidth,h=cv.offsetHeight;
  cv.width=w*dpr;cv.height=h*dpr;c.scale(dpr,dpr);
  const mx=Math.max(...d),mn=Math.min(...d),rng=mx-mn||1,step=w/(d.length-1);
  c.beginPath();d.forEach((v,i)=>{const x=i*step,y=h-4-((v-mn)/rng)*(h-8);i===0?c.moveTo(x,y):c.lineTo(x,y)});
  c.strokeStyle=col;c.lineWidth=1.5;c.stroke();
  c.lineTo((d.length-1)*step,h);c.lineTo(0,h);c.closePath();
  c.fillStyle=col.replace("rgb","rgba").replace(")",",0.07)");c.fill();
}

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

function pk(s){
  const r={};if(!s)return r;
  let m=s.match(/Entities: (\d+)/);if(m)r.ent=+m[1];
  m=s.match(/Relationships: (\d+)/);if(m)r.rel=+m[1];
  m=s.match(/Associations: (\d+)/);if(m)r.assoc=+m[1];
  m=s.match(/Insights: (\d+)/);if(m)r.ins=+m[1];
  const dm=s.match(/Domains: ({[\s\S]*})/);if(dm)try{r.dom=JSON.parse(dm[1])}catch{}
  return r;
}

function rn(){
  const gw=S.gateway_process||{},gpu=S.gpu_stats||{},sp2=S.spark_status||{},fq=S.feed_quality||{},cs=S.crontab_status||{},kg=pk(S.kg_stats),jobs=S.last_jobs||[];
  const on=gw.status==="RUNNING"&&sp2.status==="ONLINE";
  const fails=jobs.filter(j=>j.result==="FAILED").length;
  const health=!on?"offline":fails>jobs.length/2?"degraded":"nominal";
  document.getElementById("hd").style.background=health==="nominal"?"var(--green)":health==="degraded"?"var(--amber)":"var(--red)";
  document.getElementById("hl").textContent=health+" \u00b7 "+ago(S.timestamp)+" ago";

  const fH=H.map(h=>h.feed_lines).filter(v=>v!=null);
  const kH=H.map(h=>h.kg_entities).filter(v=>v!=null);
  const eH=H.map(h=>h.feed_error_rate).filter(v=>v!=null);
  const ar=(kg.ent||0)>0?Math.round((kg.assoc||0)/kg.ent*100):0;
  const gOk=on,eOk=(kg.ent||0)>50,aOk=ar>25,rOk=cs.has_reason===true;
  const dc=["#0a84ff","#30d158","#ffd60a","#bf5af2","#ff453a","#64d2ff","#ff9f0a","#ff375f"];
  const doms=kg.dom||{};const mxD=Math.max(...Object.values(doms),1);
  const pJ=jobs.filter(j=>j.result==="SUCCESS").length;
  const fJ=jobs.filter(j=>j.result==="FAILED").length;

  document.getElementById("g").innerHTML=`
    <div class="c">
      <div class="cl">Research Feed</div>
      <div class="v" style="color:var(--cyan)">${S.feed_lines||0}</div>
      <div class="lb">entries</div>
      <div class="ca"><canvas id="cf"></canvas></div>
    </div>
    <div class="c">
      <div class="cl">Knowledge Graph</div>
      <div class="mr">
        <div class="mi"><div class="v" style="color:var(--blue)">${kg.ent||0}</div><div class="lb">entities</div></div>
        <div class="mi"><div class="vs">${kg.rel||0}</div><div class="lb">relationships</div></div>
        <div class="mi"><div class="vs">${kg.assoc||0}</div><div class="lb">associations</div></div>
      </div>
      <div class="ca"><canvas id="ck"></canvas></div>
    </div>
    <div class="c">
      <div class="cl">Spark GPU</div>
      ${gpu.status==="OK"?`
        <div class="mr">
          <div class="mi"><div class="vs" style="color:${(gpu.gpu_util_pct||0)>50?"var(--green)":(gpu.gpu_util_pct||0)>5?"var(--amber)":"var(--t3)"}">${gpu.gpu_util_pct!=null?gpu.gpu_util_pct+"%":"\u2014"}</div><div class="lb">utilization</div></div>
          <div class="mi"><div class="vs">${gpu.temp_c!=null?gpu.temp_c+"\u00b0":"\u2014"}</div><div class="lb">temp</div></div>
          <div class="mi"><div class="vs">${gpu.power_w!=null?Math.round(gpu.power_w)+"W":"\u2014"}</div><div class="lb">power</div></div>
        </div>
        <div class="st">${gpu.gpu_name||""}<br>${(sp2.loaded_models||[]).map(m=>m.name+" "+m.size_gb+"GB").join(", ")}</div>
      `:'<div class="st">no gpu data</div>'}
    </div>
    <div class="c s3">
      <div class="cl">Pipeline</div>
      <div class="lc">
        <div class="ls ${gOk?"lok":"lo"}">Gather</div><div class="la">\u2192</div>
        <div class="ls ${eOk?"lok":"lw"}">Extract</div><div class="la">\u2192</div>
        <div class="ls ${aOk?"lok":"lw"}">Associate</div><div class="la">\u2192</div>
        <div class="ls ${rOk?"lok":"lo"}">Reason</div><div class="la">\u2192</div>
        <div class="ls lo">Act</div>
      </div>
      <div class="st" style="text-align:center">gather: ${gOk?"online":"down"} \u00b7 extract: ${kg.ent||0} entities \u00b7 associate: ${ar}% \u00b7 reason: ${rOk?"7am cron":"off"} \u00b7 act: manual</div>
    </div>
    <div class="c">
      <div class="cl">Feed Quality</div>
      <div class="vs" style="color:${(fq.error_rate||0)>15?"var(--red)":(fq.error_rate||0)>5?"var(--amber)":"var(--green)"}">${fq.error_rate||0}%</div>
      <div class="lb">error rate</div>
      <div class="st">json ${fq.malformed_json||0} \u00b7 timestamps ${fq.literal_timestamps||0} \u00b7 dupes ${fq.duplicates||0} \u00b7 empty ${fq.no_new_dev||0}</div>
      <div class="ca"><canvas id="ce"></canvas></div>
    </div>
    <div class="c">
      <div class="cl">Queue Jobs</div>
      <div class="mr" style="margin-bottom:10px">
        <div class="mi"><div class="vs" style="color:var(--green)">${pJ}</div><div class="lb">passed</div></div>
        <div class="mi"><div class="vs" style="color:var(--red)">${fJ}</div><div class="lb">failed</div></div>
      </div>
      ${jobs.slice(-6).map(j=>'<div class="jr"><span class="jt">'+esc(j.topic||"?")+'</span><span class="js" style="color:'+(j.result==="FAILED"?"var(--red)":j.result==="SUCCESS"?"var(--green)":"var(--t3)")+'">'+esc(j.result||"\u2014")+'</span><span class="jd">'+(j.duration_s?j.duration_s+"s":"\u2014")+'</span></div>').join("")}
    </div>
    <div class="c">
      <div class="cl">Domains</div>
      ${Object.entries(doms).map(([n,ct],i)=>'<div class="dr"><span class="dn">'+esc(n)+'</span><div class="db"><div class="df" style="width:'+Math.round(ct/mxD*100)+'%;background:'+dc[i%dc.length]+'"></div></div><span class="dv">'+ct+'</span></div>').join("")||'<div class="st">no domain data</div>'}
    </div>
    <div class="c s2">
      <div class="cl">Self-Heal</div>
      <div class="la2">${esc(S.self_heal_log||"").slice(0,2000)||"no issues"}</div>
    </div>
    <div class="c">
      <div class="cl">System</div>
      <div class="st">
        gateway ${gw.status||"?"} \u00b7 pid ${gw.pid||"?"} \u00b7 ${gw.memory_pct||"?"}% mem \u00b7 up ${gw.uptime||"?"}<br>
        spark ${sp2.status||"?"} \u00b7 cron ${cs.active||0} active<br>
        queue ${cs.has_queue?"on":"off"} \u00b7 overnight ${cs.has_overnight?"on":"off"} \u00b7 reason ${cs.has_reason?"on":"off"}<br>
        evals ${S.evaluation_count||0} \u00b7 refresh 60s
      </div>
    </div>
  `;
  setTimeout(()=>{
    const cf=document.getElementById("cf");if(cf&&fH.length>1)sp(cf,fH,"rgb(100,210,255)");
    const ck=document.getElementById("ck");if(ck&&kH.length>1)sp(ck,kH,"rgb(10,132,255)");
    const ce=document.getElementById("ce");if(ce&&eH.length>1)sp(ce,eH,"rgb(255,69,58)");
  },50);
}
ld();setInterval(ld,60000);
</script>
</body>
</html>