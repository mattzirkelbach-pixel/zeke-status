<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zeke Mission Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0e14; --surface: #14171f; --surface2: #1a1e28;
  --border: #232838; --border2: #2d3348;
  --text: #e2e4ea; --text2: #a0a5b8; --text3: #636a82;
  --accent: #4dd8c0; --accent2: #3bbfa9;
  --ok: #34d399; --warn: #f87171; --orange: #fbbf24; --blue: #60a5fa; --purple: #a78bfa;
  --radius: 10px; --card-pad: 16px 18px;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg); color: var(--text);
  padding: 20px 24px 32px; max-width: 1320px; margin: 0 auto;
  font-size: 14px; line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.title { font-size:1.35em; font-weight:700; color:var(--text); letter-spacing:-0.3px; }
.title span { color:var(--accent); }
.badge {
  font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:600;
  padding:4px 12px; border-radius:20px; letter-spacing:0.5px;
}
.badge.ok { background:rgba(52,211,153,.12); color:var(--ok); border:1px solid rgba(52,211,153,.2); }
.badge.warn { background:rgba(248,113,113,.12); color:var(--warn); border:1px solid rgba(248,113,113,.2); }
.badge.issues { background:rgba(251,191,36,.12); color:var(--orange); border:1px solid rgba(251,191,36,.2); }
.timestamp { font-size:12px; color:var(--text3); margin-bottom:16px; font-family:'JetBrains Mono',monospace; }

/* ‚îÄ‚îÄ Banners ‚îÄ‚îÄ */
.banner {
  border-radius:var(--radius); padding:10px 14px; margin-bottom:10px;
  font-size:13px; font-weight:500; display:flex; align-items:center; gap:8px;
}
.banner.warn { background:rgba(248,113,113,.06); border:1px solid rgba(248,113,113,.15); color:var(--warn); }
.banner.ok { background:rgba(52,211,153,.06); border:1px solid rgba(52,211,153,.15); color:var(--ok); }

.cycle-header {
  display:flex; align-items:center; gap:8px; padding:8px 12px 4px;
  border-top:1px solid var(--border); margin-top:6px;
  font-family:'JetBrains Mono',monospace; font-size:12px;
}
.cycle-header:first-child { border-top:none; margin-top:0; }
.cycle-label { color:var(--text2); font-weight:600; }
.cycle-time { color:var(--text3); }
.cycle-grew { font-weight:600; margin-left:auto; }
.job-issues { font-size:11px; margin-left:4px; }

/* ‚îÄ‚îÄ Top Metrics ‚îÄ‚îÄ */
.metrics { display:flex; gap:8px; margin-bottom:16px; }
.metric {
  flex:1; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px 16px; text-align:center;
  transition: border-color .2s;
}
.metric:hover { border-color:var(--border2); }
.metric .val { font-family:'JetBrains Mono',monospace; font-size:1.6em; font-weight:700; line-height:1.1; }
.metric .label { font-size:10px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1.2px; margin-top:2px; }
.metric .detail { font-size:11px; color:var(--text3); margin-top:1px; }

/* ‚îÄ‚îÄ Topology ‚îÄ‚îÄ */
.topo { display:flex; align-items:center; gap:6px; margin-bottom:16px; }
.topo-node {
  flex:1; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px 16px; position:relative; text-align:center;
}
.topo-node .name { font-weight:600; font-size:13px; }
.topo-node .desc { font-size:11px; color:var(--text3); }
.topo-dot { position:absolute; top:8px; right:8px; width:7px; height:7px; border-radius:50%; }
.topo-dot.on { background:var(--ok); box-shadow:0 0 6px rgba(52,211,153,.4); }
.topo-dot.off { background:var(--warn); box-shadow:0 0 6px rgba(248,113,113,.4); }
.topo-dot.idle { background:var(--orange); box-shadow:0 0 6px rgba(251,191,36,.3); }
.topo-arrow { color:var(--text3); font-size:11px; font-weight:500; }

/* ‚îÄ‚îÄ Cards Grid ‚îÄ‚îÄ */
.grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:14px; }
.grid-2 { grid-template-columns:repeat(2,1fr); }
.card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:var(--card-pad);
  transition: border-color .2s;
}
.card:hover { border-color:var(--border2); }
.card h2 {
  font-size:10px; font-weight:700; color:var(--text3);
  text-transform:uppercase; letter-spacing:1.2px; margin-bottom:10px;
}
.row { display:flex; justify-content:space-between; align-items:baseline; padding:3px 0; }
.row .label { font-size:13px; color:var(--text2); }
.row .value {
  font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:500;
}

/* Value colors */
.c-ok { color:var(--ok); } .c-warn { color:var(--warn); }
.c-accent { color:var(--accent); } .c-blue { color:var(--blue); }
.c-orange { color:var(--orange); } .c-purple { color:var(--purple); }
.c-dim { color:var(--text3); }

/* ‚îÄ‚îÄ Topic bars ‚îÄ‚îÄ */
.topic-row { display:flex; align-items:center; gap:8px; padding:2px 0; }
.topic-name { font-size:12px; color:var(--text2); min-width:130px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.topic-bar-bg { flex:1; height:6px; background:var(--surface2); border-radius:3px; overflow:hidden; }
.topic-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
.topic-count { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text3); min-width:20px; text-align:right; }

/* ‚îÄ‚îÄ Jobs ‚îÄ‚îÄ */
.section-title {
  font-size:10px; font-weight:700; color:var(--text3);
  text-transform:uppercase; letter-spacing:1.2px; margin:16px 0 8px;
}
.job-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:7px 12px; margin:2px 0; border-radius:6px; font-size:13px;
}
.job-row.success { background:rgba(52,211,153,.04); }
.job-row.FAILED, .job-row.fail { background:rgba(248,113,113,.04); }
.job-row.bad_output, .job-row.timeout { background:rgba(251,191,36,.04); }
.job-name { font-weight:500; }
.job-meta { font-size:12px; color:var(--text3); font-family:'JetBrains Mono',monospace; }
.job-status { font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:600; min-width:60px; text-align:right; }
.job-status.success { color:var(--ok); }
.job-status.FAILED, .job-status.fail { color:var(--warn); }
.job-status.bad_output, .job-status.timeout { color:var(--orange); }

/* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
.chart-container {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:var(--card-pad); margin-bottom:14px;
}
.chart-header {
  display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;
}
.chart-title { font-size:10px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:1.2px; }
.chart-subtitle { font-size:11px; color:var(--text3); font-family:'JetBrains Mono',monospace; }
.chart-area { position:relative; height:80px; display:flex; align-items:flex-end; gap:1px; }
.chart-bar {
  flex:1; min-width:2px; border-radius:2px 2px 0 0;
  background:var(--accent); transition:opacity .15s; cursor:default;
}
.chart-bar:hover { opacity:1 !important; }
.chart-axis {
  display:flex; justify-content:space-between; padding-top:6px;
  font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--text3);
}
.chart-y-label {
  position:absolute; left:-2px; font-family:'JetBrains Mono',monospace;
  font-size:9px; color:var(--text3); pointer-events:none;
}

/* ‚îÄ‚îÄ Research Feed ‚îÄ‚îÄ */
.feed-item {
  padding:8px 0; border-bottom:1px solid var(--border); font-size:13px;
}
.feed-item:last-child { border-bottom:none; }
.feed-topic { color:var(--accent); font-weight:500; font-size:12px; }
.feed-finding { color:var(--text2); line-height:1.4; }
.feed-time { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text3); }

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.footer {
  text-align:center; padding-top:20px; font-size:11px; color:var(--text3);
  border-top:1px solid var(--border); margin-top:8px;
}
.footer a { color:var(--accent); text-decoration:none; }
.footer a:hover { text-decoration:underline; }

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
.animate { animation: fadeUp .35s ease-out both; }
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}
.d4{animation-delay:.2s}.d5{animation-delay:.25s}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width:900px) {
  .grid { grid-template-columns:1fr 1fr; }
  .metrics { flex-wrap:wrap; }
  .metric { min-width:calc(50% - 4px); }
}
@media (max-width:600px) {
  .grid, .grid-2 { grid-template-columns:1fr; }
  .topo { flex-wrap:wrap; }
  .topo-arrow { display:none; }
}
</style></head><body>

<div class="header animate">
  <div class="title"><span>‚ö°</span> Mission Control</div>
  <div class="badge" id="badge">loading</div>
</div>
<div class="timestamp animate d1" id="ts">‚Äî</div>
<div id="banners"></div>
<div class="metrics animate d2" id="metrics"></div>
<div id="topo" class="animate d3"></div>
<div class="grid animate d3" id="grid-main"></div>
<div id="jobs-section" class="animate d4"></div>
<div id="chart-feed" class="animate d4"></div>
<div id="chart-longitudinal" class="animate d5"></div>
<div class="grid grid-2 animate d5" id="grid-lower"></div>
<div id="research-section" class="animate d5"></div>

<div class="footer">
  Mission Control v11 ¬∑ 30s auto-refresh ¬∑
  <a href="diagnostic.json">diagnostic</a> ¬∑
  <a href="status.json">status</a> ¬∑
  <a href="daily-snapshots.jsonl">snapshots</a>
</div>

<script>
const $=s=>document.querySelector(s);
const fmt=n=>n!=null?n.toLocaleString():'‚Äî';
const dur=s=>{const n=parseFloat(s);return isNaN(n)?'‚Äî':n>=60?(n/60).toFixed(1)+'m':Math.round(n)+'s'};

// Parse "2/22 2:28PM ET" into a Date
function parseET(s){
  if(!s)return null;
  try{
    // Handle "2/22 2:28PM ET" format
    const m=s.match(/(\d+)\/(\d+)\s+(\d+):(\d+)(AM|PM)\s*ET/i);
    if(m){
      let h=parseInt(m[3]); const min=parseInt(m[4]);
      if(m[5].toUpperCase()==='PM'&&h<12)h+=12;
      if(m[5].toUpperCase()==='AM'&&h===12)h=0;
      const d=new Date();d.setMonth(parseInt(m[1])-1);d.setDate(parseInt(m[2]));
      d.setHours(h,min,0,0);
      return d;
    }
    // Handle "2:28PM" (no date)
    const m2=s.match(/(\d+):(\d+)(AM|PM)/i);
    if(m2){
      let h=parseInt(m2[1]);const min=parseInt(m2[2]);
      if(m2[3].toUpperCase()==='PM'&&h<12)h+=12;
      if(m2[3].toUpperCase()==='AM'&&h===12)h=0;
      const d=new Date();d.setHours(h,min,0,0);return d;
    }
    return new Date(s);
  }catch{return null}
}

function relTime(s){
  const d=parseET(s);
  if(!d||isNaN(d.getTime()))return s||'‚Äî';
  const sec=(Date.now()-d.getTime())/1000;
  if(sec<0)return s;
  if(sec<120)return Math.round(sec)+'s ago';
  if(sec<7200)return Math.round(sec/60)+'m ago';
  if(sec<172800)return Math.round(sec/3600)+'h ago';
  return Math.round(sec/86400)+'d ago';
}

function Row(label,value,colorClass){
  return `<div class="row"><span class="label">${label}</span><span class="value ${colorClass||''}">${value}</span></div>`;
}

async function loadJSON(u){try{const r=await fetch(u+'?t='+Date.now());return r.ok?r.json():null}catch{return null}}
async function loadJSONL(u){try{const r=await fetch(u+'?t='+Date.now());if(!r.ok)return[];
return(await r.text()).trim().split('\n').filter(l=>l).map(l=>{try{return JSON.parse(l)}catch{return null}}).filter(Boolean)}catch{return[]}}

async function render(){
  const [d,s,snaps]=await Promise.all([loadJSON('diagnostic.json'),loadJSON('status.json'),loadJSONL('daily-snapshots.jsonl')]);
  if(!d){$('#ts').textContent='‚ùå Cannot load data';return}

  const a=d.activity||{},f=d.feed||{},c=d.cost||{},sp=d.spark||{},sc=d.scheduler||{},gw=d.gateway||{},h=d.health||{};
  const rc=(window._rc=(window._rc||0)+1);

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  $('#ts').textContent=(d.timestamp_local||'')+' ¬∑ refresh #'+rc;
  const hs=h.status||'UNKNOWN';
  const b=$('#badge');
  if(hs==='HEALTHY'){b.textContent='‚óè Healthy';b.className='badge ok';}
  else if(hs==='ISSUES_FOUND'){b.textContent='‚ö† '+h.issue_count+' Issue'+(h.issue_count>1?'s':'');b.className='badge issues';}
  else{b.textContent='‚óè '+hs;b.className='badge warn';}

  // ‚îÄ‚îÄ Banners ‚îÄ‚îÄ
  let ban='';
  if(h.issues?.length)ban+=h.issues.map(i=>`<div class="banner warn">‚ö†Ô∏è ${i}</div>`).join('');
  if(c.is_zero_cost)ban+=`<div class="banner ok">üí∞ Zero-cost operation ‚Äî all inference on local DGX Spark</div>`;
  $('#banners').innerHTML=ban;

  // ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ
  const sr=a.jobs_today>0?Math.round(a.success_today/a.jobs_today*100):0;
  const costV=c.is_zero_cost?'$0':'$'+(c.estimated_cost_today||0).toFixed(2);
  let mt='';
  mt+=`<div class="metric"><div class="val c-accent">${fmt(f.total_lines||0)}</div><div class="label">Feed Entries</div><div class="detail">+${a.feed_growth_today||0} today</div></div>`;
  mt+=`<div class="metric"><div class="val c-blue">${fmt(a.jobs_today||0)}</div><div class="label">Jobs Run</div><div class="detail">${sr}% success rate</div></div>`;
  mt+=`<div class="metric"><div class="val c-ok">${a.cycle_count||0}</div><div class="label">Cycles</div><div class="detail">${a.success_today||0} jobs succeeded</div></div>`;
  mt+=`<div class="metric"><div class="val" style="color:${(a.fail_today||0)>0?'var(--warn)':'var(--ok)'}">${(a.fail_today||0)+(a.timeout_today||0)}</div><div class="label">Failed</div><div class="detail">${a.timeout_today||0} timeouts</div></div>`;
  mt+=`<div class="metric"><div class="val" style="color:var(--ok)">${costV}</div><div class="label">Cost</div><div class="detail">${(c.model||'').split('(')[0].trim()}</div></div>`;
  $('#metrics').innerHTML=mt;

  // ‚îÄ‚îÄ Topology ‚îÄ‚îÄ
  const spOnline=sp.online===true;
  const spInfer=sp.inference_active;
  let tp='<div class="topo">';
  tp+=`<div class="topo-node"><div class="topo-dot ${sc.running?'on':'off'}"></div><div class="name">Scheduler</div><div class="desc">${sc.type||'python'} ¬∑ PID ${(sc.pids||[])[0]||'‚Äî'}</div></div>`;
  tp+='<div class="topo-arrow">‚Üí</div>';
  tp+=`<div class="topo-node"><div class="topo-dot ${gw.running?'on':'off'}"></div><div class="name">Gateway</div><div class="desc">OpenClaw</div></div>`;
  tp+='<div class="topo-arrow">‚Üí</div>';
  tp+=`<div class="topo-node"><div class="topo-dot ${spOnline?(spInfer?'on':'idle'):'off'}"></div><div class="name">DGX Spark</div><div class="desc">${spInfer?'inferring':sp.model_stuck?'stuck':'idle'}</div></div>`;
  tp+='</div>';
  $('#topo').innerHTML=tp;

  // ‚îÄ‚îÄ Grid: Spark ¬∑ Activity ¬∑ Feed Quality ‚îÄ‚îÄ
  let g='';

  // Spark
  let spC='';
  spC+=Row('Status',spOnline?'Online':'Offline',spOnline?'c-ok':'c-warn');
  if(sp.detail){
    const p=sp.detail.split('¬∑').length>1?sp.detail.split('¬∑'):sp.detail.split('‚Ä¢');
    const pts=p.map(s=>s.trim());
    if(pts[0])spC+=Row('Model',pts[0],'c-accent');
    if(sp.vram_estimate_gb)spC+=Row('VRAM',sp.vram_estimate_gb+'GB','c-blue');
    if(sp.model_params)spC+=Row('Size',sp.model_params,'');
    if(sp.model_quant)spC+=Row('Quant',sp.model_quant,'');
    if(sp.response_ms!=null)spC+=Row('Latency',sp.response_ms+'ms',sp.response_ms<100?'c-ok':'c-orange');
  } else {
    spC+=Row('VRAM',(sp.vram_estimate_gb||'‚Äî')+'GB','c-blue');
    spC+=Row('Latency',(sp.response_ms||'‚Äî')+'ms','');
  }
  g+=`<div class="card"><h2>DGX Spark</h2>${spC}</div>`;

  // Activity ‚Äî show relative times
  let actC='';
  const stateColor=a.state?.includes('running')?'c-ok':a.state?.includes('sleep')?'c-blue':'c-orange';
  actC+=Row('State',a.state||'‚Äî',stateColor);
  actC+=Row('Last Job',a.last_job||'‚Äî','c-accent');
  const ljRel=relTime(a.last_job_time);
  actC+=Row('Last Run',ljRel,ljRel.includes('ago')?'c-ok':'');
  const lcRel=relTime(a.last_cycle);
  actC+=Row('Last Cycle',lcRel,lcRel.includes('ago')?'c-ok':'');
  actC+=Row('Next Cycle',a.next_cycle_est||'‚Äî','c-blue');
  g+=`<div class="card"><h2>Activity</h2>${actC}</div>`;

  // Feed Quality
  let fqC='';
  const cl=f.recent_50_clean||0,tr=f.recent_50_trivial||0,br=f.recent_50_broken||0;
  const t50=cl+tr+br||50;
  fqC+=Row('Clean',cl+' / '+t50,cl/t50>.6?'c-ok':'c-warn');
  if(tr>0)fqC+=Row('Trivial',tr,'c-orange');
  if(br>0)fqC+=Row('Broken',br,'c-warn');
  fqC+=Row('Last Write',(f.last_modified_minutes_ago!=null?f.last_modified_minutes_ago+'m ago':'‚Äî'),'');
  // Topic bars
  const topics=f.topic_distribution||{};
  const topicEntries=Object.entries(topics).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(topicEntries.length){
    const mx=Math.max(...topicEntries.map(e=>e[1]),1);
    fqC+='<div style="margin-top:8px">';
    for(const[t,n]of topicEntries){
      const short=t.length>22?t.substring(0,20)+'‚Ä¶':t;
      fqC+=`<div class="topic-row"><span class="topic-name" title="${t}">${short}</span><div class="topic-bar-bg"><div class="topic-bar-fill" style="width:${Math.max(n/mx*100,6)}%"></div></div><span class="topic-count">${n}</span></div>`;
    }
    fqC+='</div>';
  }
  g+=`<div class="card"><h2>Feed Quality</h2>${fqC}</div>`;
  $('#grid-main').innerHTML=g;

  // ‚îÄ‚îÄ Jobs (cycle-grouped with timestamps) ‚îÄ‚îÄ
  const cycles=d?.recent_cycles||[];
  const fallbackJobs=(d?.recent_jobs||s?.last_jobs||[]).filter(j=>j.topic||j.name);
  let jH='';

  if(cycles.length){
    jH='<div class="section-title">Recent Jobs</div>';
    for(const cyc of cycles){
      const cTime=cyc.time_display||'?';
      const cNum=cyc.cycle||'?';
      const cGrew=cyc.feed_growth||0;
      jH+=`<div class="cycle-header"><span class="cycle-label">Cycle ${cNum}</span><span class="cycle-time">${cTime}</span><span class="cycle-grew c-ok">+${cGrew}</span></div>`;
      for(const j of (cyc.jobs||[])){
        const nm=j.name||'‚Äî';
        const st=j.status||'‚Äî';
        const d2=j.duration;
        const gr=j.grew;
        const issues=(j.issues||[]);
        let issueHtml='';
        if(issues.length){
          issueHtml=`<span class="job-issues c-orange"> ‚ö† ${issues.join(', ')}</span>`;
        }
        jH+=`<div class="job-row ${st}"><span class="job-name">${nm}</span><span class="job-meta">${d2?dur(d2):''} ${gr!=null&&gr>0?'<span class="c-ok"> +'+gr+'</span>':''}${issueHtml}</span><span class="job-status ${st}">${st}</span></div>`;
      }
    }
  } else if(fallbackJobs.length){
    jH='<div class="section-title">Recent Jobs</div>';
    for(const j of fallbackJobs){
      const nm=j.topic||j.name||j.job||'‚Äî';
      const st=j.result||j.status||'‚Äî';
      const d2=j.duration_s||j.duration;
      const gr=j.grew!=null?j.grew:j.feed_added;
      jH+=`<div class="job-row ${st}"><span class="job-name">${nm}</span><span class="job-meta">${d2?dur(d2):''} ${gr!=null&&gr>0?'<span class="c-ok"> +'+gr+'</span>':''}</span><span class="job-status ${st}">${st}</span></div>`;
    }
  }
  $('#jobs-section').innerHTML=jH;

  // ‚îÄ‚îÄ Feed Growth Chart (Today) ‚îÄ‚îÄ
  const fh=d.feed_history||[];
  let fgH='';
  if(fh.length>3){
    const vals=fh.map(h=>({v:h.v||h.value||h,t:h.t||0,l:h.l||''}));
    const vs=vals.map(x=>typeof x.v==='number'?x.v:0);
    const mn=Math.min(...vs),mx=Math.max(...vs),rng=mx-mn||1;

    // Pick ~8 evenly spaced time labels
    const step=Math.max(1,Math.floor(vals.length/8));
    const labels=[];
    for(let i=0;i<vals.length;i+=step)labels.push({i,l:vals[i].l});
    if(labels[labels.length-1]?.i!==vals.length-1)labels.push({i:vals.length-1,l:vals[vals.length-1].l});

    fgH+=`<div class="chart-container"><div class="chart-header"><span class="chart-title">Feed Growth ‚Äî Today</span><span class="chart-subtitle">${mn} ‚Üí ${mx} entries</span></div>`;
    fgH+='<div class="chart-area">';
    for(let i=0;i<vals.length;i++){
      const pct=Math.max(((vs[i]-mn)/rng)*100,2);
      const op=(.3+.7*(i/vals.length)).toFixed(2);
      fgH+=`<div class="chart-bar" style="height:${pct}%;opacity:${op}" title="${vals[i].l}: ${vs[i]} entries"></div>`;
    }
    fgH+='</div>';
    fgH+='<div class="chart-axis">';
    // Render time labels
    const totalW=vals.length;
    for(const lb of labels){
      if(lb.l)fgH+=`<span>${lb.l}</span>`;
    }
    fgH+='</div></div>';
  }
  $('#chart-feed').innerHTML=fgH;

  // ‚îÄ‚îÄ Longitudinal Chart ‚îÄ‚îÄ
  let lH='';
  if(snaps.length>1){
    const sv=snaps.map(s=>s.feed_total||0);
    const smn=Math.min(...sv),smx=Math.max(...sv),srng=smx-smn||1;

    lH+=`<div class="chart-container"><div class="chart-header"><span class="chart-title">System Growth ‚Äî Longitudinal</span><span class="chart-subtitle">${snaps.length} snapshots</span></div>`;
    lH+='<div class="chart-area">';
    for(let i=0;i<snaps.length;i++){
      const pct=Math.max(((sv[i]-smn)/srng)*100,3);
      const op=(.3+.7*(i/snaps.length)).toFixed(2);
      const ev=snaps[i].event||'';
      const color=ev.includes('clean')?'var(--orange)':'var(--accent)';
      lH+=`<div class="chart-bar" style="height:${pct}%;opacity:${op};background:${color}" title="${snaps[i].date} ${snaps[i].hour}: ${sv[i]} entries"></div>`;
    }
    lH+='</div>';
    lH+='<div class="chart-axis">';
    // First and last date
    lH+=`<span>${snaps[0].date} ${snaps[0].hour}</span>`;
    if(snaps.length>2)lH+=`<span>${snaps[Math.floor(snaps.length/2)].hour}</span>`;
    lH+=`<span>${snaps[snaps.length-1].date} ${snaps[snaps.length-1].hour}</span>`;
    lH+='</div></div>';
  }
  $('#chart-longitudinal').innerHTML=lH;

  // ‚îÄ‚îÄ Lower Grid: KG ¬∑ GPU ¬∑ Automation ‚îÄ‚îÄ
  let gl='';

  // KG ‚Äî parse string, show only key metrics
  if(d?.kg_stats){
    const kg=d.kg_stats;
    let kgC='';
    if(typeof kg==='string'){
      const lines=kg.split('\n');
      for(const line of lines){
        const m=line.match(/^\s*(Entities|Relationships|Associations|Insights)\s*:\s*(\d+)/);
        if(m){
          const colors={Entities:'c-accent',Relationships:'c-blue',Associations:'c-purple',Insights:'c-orange'};
          kgC+=Row(m[1],m[2],colors[m[1]]||'');
        }
      }
    } else {
      kgC+=Row('Entities',fmt(kg.entities||kg.Entities||0),'c-accent');
      kgC+=Row('Relations',fmt(kg.relations||kg.Relationships||0),'c-blue');
      kgC+=Row('Associations',fmt(kg.associations||kg.Associations||0),'c-purple');
    }
    if(kgC)gl+=`<div class="card"><h2>Knowledge Graph</h2>${kgC}</div>`;
  }

  // GPU
  if(d?.gpu_stats){
    const gpu=d.gpu_stats;
    let gpuC='';
    const gst=gpu.status||'unknown';
    gpuC+=Row('Status',gst.includes('OK')?'Online':gst,gst.includes('OK')?'c-ok':'c-orange');
    if(gpu.gpu_util_pct!=null)gpuC+=Row('Utilization',gpu.gpu_util_pct+'%','c-blue');
    if(gpu.temp_c!=null)gpuC+=Row('Temperature',gpu.temp_c+'¬∞C',gpu.temp_c>80?'c-warn':'c-ok');
    if(gpu.power_w!=null)gpuC+=Row('Power',gpu.power_w+'W','');
    if(gpu.gpu_name)gpuC+=Row('GPU',gpu.gpu_name,'c-accent');
    gl+=`<div class="card"><h2>GPU</h2>${gpuC}</div>`;
  }

  // Automation
  const auto=d.automation||{};
  if(Object.keys(auto).length){
    let autoC='';
    const layerNames={layer1:'L1 ¬∑ Execution',layer2:'L2 ¬∑ Oversight',layer3:'L3 ¬∑ Intelligence'};
    for(const[k,v]of Object.entries(auto)){
      const label=layerNames[k]||k;
      const val=typeof v==='string'?v:(v?.status||JSON.stringify(v));
      const cls=val?.includes('DEPLOYED')?'c-ok':val?.includes('PROGRESS')?'c-orange':'c-blue';
      autoC+=Row(label,val,cls);
    }
    gl+=`<div class="card"><h2>Automation</h2>${autoC}</div>`;
  }

  // Feed Quality Deep (from diagnostic.json)
  if(d?.feed_quality){
    const fq=d.feed_quality;
    let dqC='';
    dqC+=Row('Total Evaluated',fq.total||'‚Äî','');
    // error_rate is already a percentage number
    const er=fq.error_rate;
    const erStr=er!=null?er.toFixed(1)+'%':'‚Äî';
    dqC+=Row('Error Rate',erStr,er>20?'c-warn':er>5?'c-orange':'c-ok');
    if(fq.malformed_json>0)dqC+=Row('Malformed JSON',fq.malformed_json,'c-warn');
    if(fq.duplicates>0)dqC+=Row('Duplicates',fq.duplicates,'c-orange');
    if(fq.literal_timestamps>0)dqC+=Row('Bad Timestamps',fq.literal_timestamps,'c-orange');
    gl+=`<div class="card"><h2>Feed Audit</h2>${dqC}</div>`;
  }

  $('#grid-lower').innerHTML=gl;

  // ‚îÄ‚îÄ Latest Research ‚îÄ‚îÄ
  const entries=f.last_entries||[];
  let rH='';
  if(entries.length){
    rH='<div class="section-title">Latest Research</div><div class="card">';
    for(const e of entries.slice(-5)){
      if(typeof e==='string'){
        // Parse "[2/22 5:47PM ET] topic ‚Äî finding..."
        const m=e.match(/^\[(.+?)\]\s*(.+?)\s*[‚Äî‚Äì-]\s*(.+)/);
        if(m){
          rH+=`<div class="feed-item"><span class="feed-topic">${m[2]}</span> <span class="feed-time">${m[1]}</span><div class="feed-finding">${m[3]}</div></div>`;
        } else {
          rH+=`<div class="feed-item"><div class="feed-finding">${e.substring(0,200)}</div></div>`;
        }
      } else if(typeof e==='object'){
        rH+=`<div class="feed-item"><span class="feed-topic">${e.topic||''}</span> <span class="feed-time">${e.timestamp||''}</span><div class="feed-finding">${(e.finding||e.insight||'').substring(0,200)}</div></div>`;
      }
    }
    rH+='</div>';
  }
  $('#research-section').innerHTML=rH;
}

render();
setInterval(render,30000);
</script></body></html>