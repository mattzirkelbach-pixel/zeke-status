<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeke Mission Control</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');

  :root {
    --bg: #08090a;
    --surface: #111214;
    --surface-alt: #161819;
    --raised: #1c1d1f;
    --border: #222426;
    --border-dim: #1a1b1d;
    --text: #e4e5e7;
    --muted: #7a7d82;
    --dim: #454750;
    --green: #2dd4a0;
    --green-dim: #0d3d30;
    --amber: #f0b429;
    --amber-dim: #3d2e0a;
    --red: #e5484d;
    --red-dim: #3d1214;
    --blue: #4da3ff;
    --blue-dim: #152640;
    --purple: #9d8cff;
    --cyan: #22d3ee;
    --mono: 'JetBrains Mono', 'SF Mono', 'Menlo', monospace;
    --sans: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    padding: 20px 24px;
    max-width: 940px;
    margin: 0 auto;
    min-height: 100vh;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  @keyframes dotPulse {
    0%, 100% { box-shadow: 0 0 4px var(--green); }
    50% { box-shadow: 0 0 10px var(--green), 0 0 20px rgba(45,212,160,0.2); }
  }

  .header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 20px;
    animation: fadeUp 0.5s ease;
  }
  .header h1 {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: var(--text);
  }
  .header-sub {
    font-size: 10px;
    font-family: var(--mono);
    color: var(--dim);
    margin-top: 2px;
  }

  .indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--muted);
  }
  .indicator .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  .dot-up { background: var(--green); animation: dotPulse 2s infinite; }
  .dot-warn { background: var(--amber); }
  .dot-down { background: var(--red); }
  .dot-off { background: var(--dim); }

  .metrics {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 18px;
    animation: fadeUp 0.5s ease 0.05s both;
  }
  .metric {
    padding: 12px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    text-align: center;
  }
  .metric-val {
    font-size: 24px;
    font-family: var(--mono);
    font-weight: 700;
    line-height: 1;
  }
  .metric-label {
    font-size: 8px;
    font-family: var(--mono);
    color: var(--dim);
    margin-top: 5px;
    letter-spacing: 0.1em;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    animation: fadeUp 0.5s ease 0.1s both;
  }

  .card {
    padding: 16px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }
  .card-wide { grid-column: 1 / -1; }
  .card-title {
    font-size: 10px;
    font-weight: 600;
    color: var(--dim);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 14px;
    font-family: var(--mono);
  }

  /* Topology */
  .topo-nodes {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr;
    align-items: center;
    gap: 0;
    margin-bottom: 14px;
    padding: 8px 0;
  }
  .topo-node {
    padding: 12px 14px;
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 10px;
    text-align: center;
    position: relative;
  }
  .topo-node-label {
    font-size: 11px;
    font-family: var(--mono);
    font-weight: 600;
    color: var(--text);
  }
  .topo-node-sub {
    font-size: 8px;
    font-family: var(--mono);
    color: var(--dim);
    margin-top: 2px;
  }
  .topo-node .dot {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .topo-arrow {
    text-align: center;
    color: var(--dim);
    font-size: 16px;
    padding: 0 6px;
    position: relative;
  }
  .topo-arrow.active { color: var(--green); }
  .topo-arrow.active::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 4px;
    height: 4px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    transform: translate(-50%, -50%);
  }

  .topo-details {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  .topo-detail {
    padding: 8px 10px;
    background: var(--surface-alt);
    border-radius: 8px;
  }
  .topo-detail-label {
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
    margin-bottom: 3px;
  }
  .topo-detail-val {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text);
  }
  .topo-detail-sub {
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
  }

  /* Chart */
  .chart-container { position: relative; }
  .chart-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
  }

  /* Jobs */
  .job-row {
    display: grid;
    grid-template-columns: 95px 1fr 55px 20px;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    border-bottom: 1px solid var(--border-dim);
  }
  .job-name {
    font-size: 10px;
    font-family: var(--mono);
    color: var(--muted);
  }
  .job-bar-bg {
    height: 14px;
    background: var(--surface-alt);
    border-radius: 3px;
    overflow: hidden;
  }
  .job-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
  }
  .job-meta {
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
    text-align: right;
  }

  /* Hardware */
  .hw-item {
    padding: 10px 12px;
    background: var(--surface-alt);
    border-radius: 8px;
    border: 1px solid var(--border-dim);
    margin-bottom: 8px;
  }
  .hw-item:last-child { margin-bottom: 0; }
  .hw-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .hw-name {
    font-size: 11px;
    font-family: var(--mono);
    font-weight: 600;
    color: var(--text);
  }
  .hw-detail {
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
    margin-top: 4px;
  }

  /* Feed entries */
  .feed-entry {
    font-size: 10px;
    font-family: var(--mono);
    padding: 3px 0;
    padding-left: 10px;
    border-left: 2px solid var(--border-dim);
    color: var(--dim);
  }
  .feed-entry:first-child {
    border-left-color: var(--green);
    color: var(--muted);
  }

  /* Issues */
  .issues-card {
    background: rgba(240, 180, 41, 0.04);
    border-color: var(--amber-dim);
  }
  .issue-item {
    font-size: 10px;
    font-family: var(--mono);
    color: var(--muted);
    padding: 4px 0;
    border-bottom: 1px solid var(--border-dim);
  }
  .issue-item:last-child { border-bottom: none; }

  .footer {
    margin-top: 20px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    font-family: var(--mono);
    color: var(--dim);
  }
  .footer a { color: var(--muted); text-decoration: none; }
  .footer a:hover { color: var(--text); }

  @media (max-width: 700px) {
    .metrics { grid-template-columns: repeat(3, 1fr); }
    .grid { grid-template-columns: 1fr; }
    .card-wide { grid-column: auto; }
    .topo-details { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>Mission Control</h1>
    <div class="header-sub" id="header-sub">loading...</div>
  </div>
  <div id="health-indicator" class="indicator">
    <span class="dot dot-off"></span> LOADING
  </div>
</div>

<div class="metrics" id="metrics"></div>

<div class="grid" id="grid"></div>

<div class="footer">
  <span>Zeke v2 • Layer 1 Scheduler • <span id="footer-feed">—</span> entries</span>
  <a href="https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main/diagnostic.json" target="_blank">raw diagnostic ↗</a>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const GITHUB_RAW = "https://raw.githubusercontent.com/mattzirkelbach-pixel/zeke-status/main";
let refreshCount = 0;
let feedHistory = [];
let cycleHistory = [];

// ============================================================
// SVG CHART BUILDER
// ============================================================
function buildChart(points, opts = {}) {
  const {
    width = 400, height = 110, color = '#2dd4a0',
    yLabel = '', showDots = true
  } = opts;

  if (!points || points.length < 2) {
    return `<div style="width:${width}px;height:${height}px;display:flex;align-items:center;justify-content:center">
      <span style="font-size:11px;font-family:var(--mono);color:var(--dim)">Waiting for data...</span></div>`;
  }

  const pad = { top: 8, right: 10, bottom: 22, left: 36 };
  const w = width - pad.left - pad.right;
  const h = height - pad.top - pad.bottom;
  const vals = points.map(p => p.value);
  const yMin = Math.min(...vals);
  const yMax = Math.max(...vals);
  const yRange = yMax - yMin || 1;
  const tMin = points[0].time;
  const tMax = points[points.length - 1].time;
  const tRange = tMax - tMin || 1;

  const toX = t => pad.left + ((t - tMin) / tRange) * w;
  const toY = v => pad.top + h - ((v - yMin) / yRange) * h;

  const pathPts = points.map(p => `${toX(p.time).toFixed(1)},${toY(p.value).toFixed(1)}`);
  const lineD = pathPts.map((pt, i) => `${i === 0 ? 'M' : 'L'} ${pt}`).join(' ');
  const areaD = lineD + ` L ${toX(tMax).toFixed(1)} ${(pad.top + h).toFixed(1)} L ${toX(tMin).toFixed(1)} ${(pad.top + h).toFixed(1)} Z`;

  const gradId = 'g' + Math.random().toString(36).slice(2, 8);

  // Y labels
  const yTicks = [yMin, yMin + yRange * 0.5, yMax].map(v => Math.round(v));
  let yGrids = yTicks.map(v => `<line x1="${pad.left}" y1="${toY(v).toFixed(1)}" x2="${width - pad.right}" y2="${toY(v).toFixed(1)}" stroke="var(--border-dim)" stroke-width="0.5" stroke-dasharray="3,3"/>
    <text x="${pad.left - 4}" y="${(toY(v) + 3).toFixed(1)}" text-anchor="end" fill="var(--dim)" font-size="9" font-family="var(--mono)">${v}</text>`).join('\n');

  // Time labels — pick ~6 evenly spaced
  const step = Math.max(1, Math.floor(points.length / 6));
  let timeTicks = [];
  for (let i = 0; i < points.length; i += step) timeTicks.push(points[i]);
  if (timeTicks[timeTicks.length - 1] !== points[points.length - 1]) timeTicks.push(points[points.length - 1]);
  let timeLabels = timeTicks.map(p =>
    `<text x="${toX(p.time).toFixed(1)}" y="${height - 4}" text-anchor="middle" fill="var(--dim)" font-size="8" font-family="var(--mono)">${p.label}</text>`
  ).join('\n');

  // Dots
  let dots = '';
  if (showDots) {
    dots = points.map((p, i) => {
      const isLast = i === points.length - 1;
      return `<circle cx="${toX(p.time).toFixed(1)}" cy="${toY(p.value).toFixed(1)}" r="${isLast ? 3.5 : 2}" fill="${isLast ? color : color + '88'}" ${isLast ? `stroke="var(--bg)" stroke-width="1.5"` : ''}/>`;
    }).join('\n');
  }

  return `<svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="display:block;overflow:visible">
    <defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    ${yGrids}
    <path d="${areaD}" fill="url(#${gradId})"/>
    <path d="${lineD}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    ${dots}
    ${timeLabels}
  </svg>`;
}

// ============================================================
// RENDER
// ============================================================
function render(d, s) {
  const feedCount = d?.feed?.total_lines || s?.feed_lines || 0;
  const sparkOn = d?.spark?.online ?? false;
  const sparkModels = d?.spark?.models_loaded || [];
  const sparkStuck = d?.spark?.model_stuck || false;
  const sparkDetail = d?.spark?.detail || 'unknown';
  const gwUp = d?.gateway?.running ?? false;
  const schedUp = d?.scheduler?.running ?? false;
  const schedPid = d?.scheduler?.pid || '—';
  const schedUptime = d?.scheduler?.uptime_minutes || 0;
  const window = d?.scheduler?.current_window || '—';
  const today = d?.today || {};
  const jobs = d?.recent_jobs || [];
  const cycles = d?.cycles || [];
  const health = d?.health || {};
  const issues = health.issues || [];
  const entries = d?.feed?.last_entries || [];

  const sr = today.jobs_run > 0 ? Math.round((today.success / today.jobs_run) * 100) : 0;
  const allUp = schedUp && gwUp && sparkOn;

  // Header
  const now = new Date();
  document.getElementById('header-sub').textContent =
    `${window} • refresh #${refreshCount} • ${now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}`;

  const hDot = health.status === 'HEALTHY' ? 'dot-up' : issues.some(i => i.includes('CRITICAL')) ? 'dot-down' : 'dot-warn';
  document.getElementById('health-indicator').innerHTML =
    `<span class="dot ${hDot}"></span> ${health.status || 'UNKNOWN'}`;

  // Metrics
  document.getElementById('metrics').innerHTML = [
    { label: 'FEED', value: feedCount, color: 'var(--green)' },
    { label: 'TODAY +', value: today.feed_growth || 0, color: 'var(--cyan)' },
    { label: 'JOBS', value: today.jobs_run || 0, color: 'var(--blue)' },
    { label: 'SUCCESS', value: sr + '%', color: sr >= 70 ? 'var(--green)' : 'var(--amber)' },
    { label: 'COST', value: '$0', color: 'var(--green)' },
  ].map(m => `<div class="metric">
    <div class="metric-val" style="color:${m.color}">${m.value}</div>
    <div class="metric-label">${m.label}</div>
  </div>`).join('');

  // Grid
  let grid = '';

  // 1. System Topology — full width
  const arrowClass = allUp ? 'topo-arrow active' : 'topo-arrow';
  grid += `<div class="card card-wide">
    <div class="card-title">System Topology</div>
    <div class="topo-nodes">
      <div class="topo-node">
        <span class="dot ${schedUp ? 'dot-up' : 'dot-down'}"></span>
        <div class="topo-node-label">Scheduler</div>
        <div class="topo-node-sub">Python</div>
      </div>
      <div class="${arrowClass}">→</div>
      <div class="topo-node">
        <span class="dot ${gwUp ? 'dot-up' : 'dot-down'}"></span>
        <div class="topo-node-label">Gateway</div>
        <div class="topo-node-sub">OpenClaw</div>
      </div>
      <div class="${arrowClass}">→</div>
      <div class="topo-node">
        <span class="dot ${sparkOn ? (sparkStuck ? 'dot-warn' : 'dot-up') : 'dot-down'}"></span>
        <div class="topo-node-label">DGX Spark</div>
        <div class="topo-node-sub">${sparkModels[0] || 'idle'}</div>
      </div>
    </div>
    <div class="topo-details">
      <div class="topo-detail">
        <div class="topo-detail-label">SCHEDULER</div>
        <div class="topo-detail-val" style="color:${schedUp ? 'var(--text)' : 'var(--red)'}">${schedUp ? 'PID ' + schedPid : 'DOWN'}</div>
        <div class="topo-detail-sub">${schedUp ? schedUptime + 'm uptime' : 'guardian will restart'}</div>
      </div>
      <div class="topo-detail">
        <div class="topo-detail-label">SPARK GPU</div>
        <div class="topo-detail-val" style="color:${sparkOn ? (sparkStuck ? 'var(--amber)' : 'var(--text)') : 'var(--red)'}">${sparkOn ? (sparkStuck ? 'STUCK' : 'HEALTHY') : 'OFFLINE'}</div>
        <div class="topo-detail-sub">${sparkModels.length > 0 ? sparkModels[0] : 'no model loaded'}</div>
      </div>
      <div class="topo-detail">
        <div class="topo-detail-label">GATEWAY</div>
        <div class="topo-detail-val" style="color:${gwUp ? 'var(--text)' : 'var(--red)'}">${gwUp ? 'ROUTING' : 'DOWN'}</div>
        <div class="topo-detail-sub">10.0.0.143:11434</div>
      </div>
    </div>
  </div>`;

  // 2. Feed Growth chart
  grid += `<div class="card">
    <div class="card-title">Feed Growth</div>
    <div class="chart-container">${buildChart(feedHistory, { color: '#2dd4a0', yLabel: 'entries' })}</div>
    <div class="chart-footer">
      <span>${feedHistory.length} data points</span>
      <span>refreshes every 60s</span>
    </div>
  </div>`;

  // 3. Success Rate chart
  const cPts = cycles.map((c, i) => ({
    time: new Date(c.ts).getTime() || Date.now() - (cycles.length - i) * 3600000,
    value: c.jobs > 0 ? Math.round((c.success / c.jobs) * 100) : 0,
    label: (() => { try { return new Date(c.ts).toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:false}); } catch(e) { return ''; }})(),
  }));
  grid += `<div class="card">
    <div class="card-title">Cycle Success Rate</div>
    <div class="chart-container">${buildChart(cPts.length >= 2 ? cPts : null, { color: '#4da3ff', yLabel: '%' })}</div>
    <div class="chart-footer">
      <span>${cycles.length} cycles</span>
      <span>${today.success || 0} ok / ${today.timeout || 0} timeout / ${today.fail || 0} fail</span>
    </div>
  </div>`;

  // 4. Job Results
  const maxDur = Math.max(...jobs.map(j => j.duration || 0), 60);
  const statusColors = { success: 'var(--green)', timeout: 'var(--amber)', fail: 'var(--red)', bad_output: 'var(--purple)', empty: 'var(--amber)' };
  const jobRows = jobs.length > 0 ? jobs.map(j => {
    const col = statusColors[j.status] || 'var(--dim)';
    const pct = Math.max((j.duration / maxDur) * 100, 5);
    const dotCls = j.status === 'success' ? 'dot-up' : j.status === 'timeout' || j.status === 'empty' ? 'dot-warn' : 'dot-down';
    return `<div class="job-row">
      <span class="job-name">${j.name}</span>
      <div class="job-bar-bg"><div class="job-bar" style="width:${pct}%;background:linear-gradient(90deg,${col}33,${col}66)"></div></div>
      <span class="job-meta">${j.duration}s ${j.grew > 0 ? '<span style="color:var(--green)">+' + j.grew + '</span>' : ''}</span>
      <span class="dot ${dotCls}" style="width:7px;height:7px"></span>
    </div>`;
  }).join('') : '<div style="font-size:11px;font-family:var(--mono);color:var(--dim);text-align:center;padding:20px">Waiting for first cycle...</div>';

  grid += `<div class="card">
    <div class="card-title">Last Cycle Jobs</div>
    ${jobRows}
  </div>`;

  // 5. Hardware & Connections
  grid += `<div class="card">
    <div class="card-title">Hardware & Connections</div>
    <div class="hw-item">
      <div class="hw-header">
        <span class="hw-name">Mac Mini (Host)</span>
        <span class="indicator"><span class="dot dot-up" style="width:6px;height:6px"></span> LOCAL</span>
      </div>
      <div class="hw-detail">OpenClaw gateway • Python scheduler • cron guardian</div>
    </div>
    <div class="hw-item" ${sparkStuck ? 'style="border-color:var(--amber-dim)"' : ''}>
      <div class="hw-header">
        <span class="hw-name">DGX Spark (GPU)</span>
        <span class="indicator"><span class="dot ${sparkOn ? (sparkStuck ? 'dot-warn' : 'dot-up') : 'dot-down'}" style="width:6px;height:6px"></span> ${sparkOn ? '10.0.0.143' : 'OFFLINE'}</span>
      </div>
      <div class="hw-detail">128GB VRAM • Ollama ${sparkModels.length > 0 ? '• ' + sparkModels.join(', ') : '• idle'}</div>
      ${sparkStuck ? '<div class="hw-detail" style="color:var(--amber)">⚠ Model appears stuck — scheduler will handle</div>' : ''}
    </div>
    <div class="hw-item">
      <div class="hw-header">
        <span class="hw-name">Network Path</span>
        <span class="indicator"><span class="dot ${allUp ? 'dot-up' : 'dot-warn'}" style="width:6px;height:6px"></span> LAN</span>
      </div>
      <div class="hw-detail">Mac Mini → Gateway :18789 → Spark :11434 • GitHub push every cycle</div>
    </div>
    <div class="hw-item">
      <div class="hw-header">
        <span class="hw-name">Telegram</span>
        <span class="indicator"><span class="dot dot-up" style="width:6px;height:6px"></span> @Zekevonz_bot</span>
      </div>
      <div class="hw-detail">Delivery channel • action-required insights only</div>
    </div>
  </div>`;

  // 6. Health Issues (if any)
  if (issues.length > 0) {
    grid += `<div class="card card-wide issues-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span class="dot ${issues.some(i => i.includes('CRITICAL')) ? 'dot-down' : 'dot-warn'}" style="width:8px;height:8px"></span>
        <span style="font-size:12px;font-family:var(--mono);font-weight:600;color:var(--amber)">${issues.length} Issue${issues.length > 1 ? 's' : ''} Detected</span>
      </div>
      ${issues.map(i => `<div class="issue-item">${escHtml(i)}</div>`).join('')}
    </div>`;
  }

  // 7. Latest Feed Entries
  grid += `<div class="card card-wide">
    <div class="card-title">Latest Feed Entries</div>
    ${entries.length > 0
      ? entries.map((e, i) => `<div class="feed-entry" ${i === 0 ? 'style="border-left-color:var(--green);color:var(--muted)"' : ''}>${escHtml(typeof e === 'string' ? e.slice(0, 80) : JSON.stringify(e).slice(0, 80))}</div>`).join('')
      : '<div style="font-size:10px;font-family:var(--mono);color:var(--dim)">Waiting for diagnostic data...</div>'
    }
  </div>`;

  document.getElementById('grid').innerHTML = grid;
  document.getElementById('footer-feed').textContent = feedCount;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ============================================================
// FETCH
// ============================================================
async function fetchAndRender() {
  refreshCount++;
  try {
    const [dRes, sRes] = await Promise.all([
      fetch(GITHUB_RAW + '/diagnostic.json?t=' + Date.now()).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch(GITHUB_RAW + '/status.json?t=' + Date.now()).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);

    const now = new Date();
    const label = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

    // Feed history
    const fc = dRes?.feed?.total_lines || sRes?.feed_lines;
    if (fc) {
      feedHistory.push({ time: now.getTime(), value: fc, label });
      if (feedHistory.length > 48) feedHistory = feedHistory.slice(-48);
    }

    render(dRes, sRes);
  } catch (e) {
    console.error('Fetch error:', e);
  }
}

// Boot
fetchAndRender();
setInterval(fetchAndRender, 60000);
</script>
</body>
</html>
